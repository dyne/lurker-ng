#! /bin/bash -e

DBDIR=@DBDIR_expand@
BINDIR=@BINDIR_expand@
DB=$1

if test -z "$DB" -o -f "$DB"; then
  echo "Usage: ./backup <new-backup-file>"
  exit 1
fi

cd $DBDIR

echo -n "Dumping all kap databases... "
echo -n "merge "
$BINDIR/kapdump -b -k 80 -l 8 -s 2048 merge > merge.raw
echo -n "mid "
$BINDIR/kapdump -b -k 80 -l 4 -s 2048 mid   > mid.raw
echo -n "mbox "
$BINDIR/kapdump -b -k 24 -l 8 -s 1024 mbox  > mbox.raw
echo -n "offset "
$BINDIR/kapdump -k 12 -r 8 offset > offset.raw
echo -n "keyword "
$BINDIR/kapdump keyword > keyword.raw
echo "- Done"

echo -n "Building a tar.gz backup.... "
tar cf - merge.raw mid.raw mbox.raw offset.raw keyword.raw summary.flat variable.flat | gzip -c > $DB
echo "Done"

echo -n "Purging temporary files..... "
rm merge.raw mid.raw mbox.raw offset.raw keyword.raw
echo "Done"
